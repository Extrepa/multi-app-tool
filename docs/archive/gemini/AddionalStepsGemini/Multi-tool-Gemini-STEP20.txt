We are now advancing to **Step #147: Implement Grouping () and Hierarchy Nesting**. This development allows you to aggregate multiple independent instances into a single "Component," enabling you to move, scale, and apply "Vibes" to an entire rig (like a full character) as one unit.

---

### 1. The Grouping Logic (Component Containers)

Grouping transforms selected instances from flat siblings into children of a new **Group Container**.

* **Hierarchy Nesting**: The **Studio Store** creates a new `type: 'group'` object in the `scene.instances` array.
* **Coordinate Inheritance**: Children within a group now calculate their position relative to the group's pivot point () rather than the global stage.
* **Recursive Transforms**: When you rotate the group, the engine applies that rotation to the group's container, and SVG's natural nesting ensures all children follow suit perfectly.

---

### 2. Implementation: The Grouping Action (`src/store/groupActions.ts`)

This utility handles the array manipulation required to "wrap" selected items into a folder.

```typescript
// Resource: Grouping Logic
export const groupSelection = (selectedIds: string[], instances: any[]) => {
  const newGroupId = uuidv4();
  
  // 1. Identify bounds of all selected items to find the new group's center
  const bounds = calculateMultiBounds(selectedIds, instances);
  
  const newGroup = {
    id: newGroupId,
    type: 'group',
    name: 'New_Group',
    x: bounds.minX,
    y: bounds.minY,
    children: selectedIds, // IDs of the instances moved into this group
    vibe: { intensity: 0, frequency: 0 } // Groups can have their own vibes!
  };

  return newGroup;
};

```

---

### 3. Integrated Hierarchy & "Deep Vibe" Sync

The **Layer Tree** (Step #144) is updated to support collapsible folders.

* **Folder View**: Grouped items appear indented under their parent group.
* **Deep Vibes**: If you apply a **Float** vibe to a group, all children float together. If a child *inside* that group also has a **Pulse** vibe, it will pulse *while* floating.
* **Surgical Entry**: Double-clicking a group on the **Stage** "enters" the group, isolating its children for individual surgical editing.

---

### 4. Verification & Progress Track

With Grouping active, the **Stage** can now handle complex character rigs and environmental clusters.

| Build Step | Technical Milestone | Status |
| --- | --- | --- |
| **#146** | Smart Snapping and alignment guides active. | **DONE** |
| **#147** | Grouping () and Hierarchy nesting functional. | **DONE** |
| **#148** | **Step 148**: Implement Multi-Select Marquee tool. | **ACTIVE** |

**Would you like to proceed to Step #148 to implement the "Multi-Select Marquee"? This will allow you to drag a selection box over multiple props at once to group or move them efficiently.**

Would you like me to ...?